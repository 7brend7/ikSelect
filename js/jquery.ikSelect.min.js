// ikSelect 0.9.1
// Copyright (c) 2012 Igor Kozlov
// i10k.ru
(function(f,h,j,c){var b=f(h);var d={syntax:'<div class="ik_select_link"><span class="ik_select_link_text"></span></div><div class="ik_select_block"><div class="ik_select_list"></div></div>',autoWidth:true,ddFullWidth:true,customClass:"",ddCustomClass:"",ddMaxHeight:200,topShift:true,filter:false,onShow:function(){},onHide:function(){},onKeyUp:function(){},onKeyDown:function(){},onHoverMove:function(){}};var a=f([]);var i=false;var g=-1;var l=(/iphone|ipad|ipod|android/i.test(navigator.userAgent.toLowerCase()));var e=Object.prototype.toString.call(h.operamini)==="[object OperaMini]";function k(o,n){var m=this;m.element=o;m.options=f.extend({},d,n);m._defaults=d;if(m.element===c){return m}m.fakeSelect=f('<div class="ik_select">'+m.options.syntax+"</div>");m.select=f(m.element);m.link=f(".ik_select_link",m.fakeSelect);m.linkText=f(".ik_select_link_text",m.fakeSelect);m.block=f(".ik_select_block",m.fakeSelect);m.list=f(".ik_select_list",m.fakeSelect);m.listInner=f('<div class="ik_select_list_inner"/>');m.filter=f([]);m.listItemsOriginal=f([]);m.nothingFoundText=f('<div class="ik_nothing_found"/>').html(m.select.data("nothingfoundtext"));if(m.options.filter&&!l){m.filterWrap=f(".ik_select_filter_wrap",m.fakeSelect);if(!m.filterWrap.length){m.filterWrap=f('<div class="ik_select_filter_wrap"/>')}m.filter=f('<input type="text" class="ik_select_filter">');m.filterWrap.append(m.filter)}m.active=f([]);m.hover=f([]);m.hoverIndex=-1;m.listItems=f([]);m.listOptgroupItems=f([]);m.init()}f.extend(k.prototype,{init:function(){var n=this;var q=n.fakeSelect;var u=n.select;var t=n.link;var p=n.block;var r=n.list;var s=n.listInner;var m=n.filter;r.append(s);q.addClass(n.options.customClass);p.addClass(n.options.ddCustomClass);n.reset_all();if(u.attr("disabled")){n.disable_select()}t.bind("click.ikSelect",function(){if(t.hasClass("ik_select_link_disabled")){return this}if(a.length){a.data("plugin_ikSelect").hide_block()}n.show_block();if(n.options.filter){m.focus()}else{u.focus()}});u.bind("focus.ikSelect",function(){if(t.hasClass("ik_select_link_disabled")){return this}t.addClass("ik_select_link_focus");if((q.offset().top+q.height()>b.scrollTop()+b.height())||(q.offset().top+q.height()<b.scrollTop())){b.scrollTop(q.offset().top-b.height()/2)}});u.bind("blur.ikSelect",function(){if(t.hasClass("ik_select_link_disabled")){return this}t.removeClass("ik_select_link_focus")});u.bind("change.ikSelect",function(){n._select_fake_option()});var o="";m.bind("keyup.ikSelect",function(){s.show();if(o===""&&!n.listItemsOriginal.length){n.listItemsOriginal=n.listItems}if(m.val()!==o){if(m.val()===""){n.listItems=n.listItemsOriginal.show();n.listOptgroupItems.show();n.nothingFoundText.remove()}else{n.listItems=n.listItemsOriginal.show();n.listOptgroupItems.show();n.listItems.each(function(){if(f(".ik_select_option",this).html().search(new RegExp(m.val(),"i"))===-1){n.listItems=n.listItems.not(this);f(this).hide()}});if(n.listItems.length){n.nothingFoundText.remove();n.listOptgroupItems.each(function(){var v=f(this);if(!f("> ul > li:visible",v).length){v.hide()}});if(!n.listItems.filter(n.hover).length&&n.listItems.length){n._move_to(n.listItems.eq(0))}n.hoverIndex=n.listItems.index(n.hover)}else{s.hide();r.append(n.nothingFoundText)}}o=m.val()}});u.add(m).bind("keydown.ikSelect keyup.ikSelect",function(z){var A=n.listItems;if(n.hoverIndex<0){n.hoverIndex=A.index(n.hover)}var v=z.which;var x=z.type;switch(v){case 40:if(x==="keydown"){z.preventDefault();var w;if(n.hoverIndex<A.length-1){w=A.eq(++n.hoverIndex);while(w&&w.hasClass("ik_select_option_disabled")){w=A.filter(":eq("+(++n.hoverIndex)+")")}}if(w){n._move_to(w)}}break;case 38:if(x==="keydown"){z.preventDefault();var y;if(n.hoverIndex>0){y=A.eq(--n.hoverIndex);while(y&&y.hasClass("ik_select_option_disabled")){y=A.filter(":eq("+(--n.hoverIndex)+")")}}if(y){n._move_to(y)}}break;case 33:case 36:if(x==="keydown"){z.preventDefault();n._move_to(A.filter(".not(ik_select_option_disabled):first"))}break;case 34:case 35:if(x==="keydown"){z.preventDefault();n._move_to(A.filter(".not(ik_select_option_disabled):last"))}break;case 32:if(x==="keydown"&&f(this).is(u)){z.preventDefault();if(!p.is(":visible")){t.click()}else{n._select_real_option()}}break;case 13:if(x==="keydown"&&p.is(":visible")){z.preventDefault();n._select_real_option()}break;case 27:if(x==="keydown"){z.preventDefault();n.hide_block()}break;case 9:if(x==="keydown"){if(f.browser.webkit&&p.is(":visible")){z.preventDefault()}else{n.hide_block()}}break;default:if(x==="keyup"&&f(this).is(u)){n._select_fake_option()}break}if(x==="keydown"){n.options.onKeyDown(n,v);u.trigger("ikkeydown",[n,v])}if(x==="keyup"){n.options.onKeyUp(n,v);u.trigger("ikkeyup",[n,v])}});u.after(q);if(n.options.filter&&!l){r.prepend(n.filterWrap)}n.redraw();u.appendTo(q)},redraw:function(){var m=this;var x=m.select;var o=m.fakeSelect;var n=m.block;var t=m.list;var u=m.listInner;var w=m.options.autoWidth;var y=m.options.ddFullWidth;if(w||y){u.width("auto");f("ul",u).width("auto");o.width("auto");n.show().width(9999);u.css("float","left");t.css("position","absolute");var q=t.outerWidth(true);var s=t.width();t.css("position","static");n.hide().css("width","100%");u.css("float","none");if(g===-1){var v=f('<div style="width:50px; height:50px; overflow:hidden; position:absolute; top:-200px; left:-200px;"><div style="height:100px;"></div>');f("body").append(v);var r=f("div",v).innerWidth();v.css("overflow","auto");var p=f("div",v).innerWidth();f(v).remove();g=r-p}var z=o.parent().width();if(y){n.width(q);u.width(s);f("ul",u).width(s)}if(q>z){q=z}if(w){o.width(q)}}m._fix_height();x.css({position:"absolute",margin:0,padding:0,left:-9999,top:0});if(l){x.css({opacity:0,left:0,height:o.height()})}},reset_all:function(){var n=this;var m=n.select;var o=n.linkText;var p=n.listInner;o.html(m.val());p.empty();var q="";q+="<ul>";m.children().each(function(){if(this.tagName==="OPTGROUP"){var r=f(this);q+='<li class="ik_select_optgroup'+(r.is(":disabled")?" ik_select_optgroup_disabled":"")+'">';q+='<div class="ik_select_optgroup_label">'+r.attr("label")+"</div>";q+="<ul>";f("option",r).each(function(){var t=f(this);q+="<li"+(t.is(":disabled")?' class="ik_select_option_disabled"':"")+'><span class="ik_select_option'+(t[0].getAttribute("value")?"":" ik_select_option_novalue")+'" title="'+t.val()+'">'+t.html()+"</span></li>"});q+="</ul>";q+="</li>"}else{var s=f(this);q+="<li"+(s.is(":disabled")?' class="ik_select_option_disabled"':"")+'><span class="ik_select_option'+(s[0].getAttribute("value")?"":" ik_select_option_novalue")+'" title="'+s.val()+'">'+s.html()+"</span></li>"}});q+="</ul>";p.append(q);n._select_fake_option();n.listOptgroupItems=f(".ik_select_optgroup",p);n.listItems=f("li:not(.ik_select_optgroup)",p);n._attach_list_events(n.listItems);if(m.prop("disabled")){n.disable_select()}else{n.enable_select()}},_attach_list_events:function(q){var n=this;var m=n.select;var r=n.link;var p=n.linkText;var o=q.not(".ik_select_option_disabled");o.bind("click.ikSelect",function(){var s=f(".ik_select_option",this);p.html(s.html());m.val(s.attr("title"));n.active.removeClass("ik_select_active");n.active=f(this).addClass("ik_select_active");n.hide_block();if(s.hasClass("ik_select_option_novalue")){r.addClass("ik_select_link_novalue")}else{r.removeClass("ik_select_link_novalue")}m.change();m.focus()});o.bind("mouseover.ikSelect",function(){n.hoverIndex=-1;n.hover.removeClass("ik_select_hover");n.hover=f(this).addClass("ik_select_hover")});o.addClass("ik_select_has_events")},_detach_list_events:function(m){m.unbind(".ikSelect");m.removeClass("ik_select_has_events")},set_defaults:function(m){f.extend(this._defaults,m||{});return this},hide_block:function(){var n=this;var o=n.fakeSelect;var p=n.block;var m=n.select;if(n.options.filter&&!l){n.filter.val("").keyup()}if(n.listItemsOriginal.length){n.listOptgroupItems.show();n.listItems=n.listItemsOriginal.show()}p.hide().appendTo(o).css({left:"",top:""});m.removeClass(".ik_select_opened");a=f([]);m.focus();n.options.onHide(n);m.trigger("ikhide",[n])},show_block:function(){var m=this;var z=m.select;if(a.is(m.select)||!m.listItems.length){return m}else{if(a.length){a.data("plugin_ikSelect").hide_block()}}var t=m.fakeSelect;var s=m.block;var w=m.list;var x=m.listInner;var v=m.hover;var r=m.active;var q=m.listItems;s.show();z.addClass("ik_select_opened");var o=f("option",z).index(f("option:selected",z));v.removeClass("ik_select_hover");r.removeClass("ik_select_active");var u=q.eq(o);u.addClass("ik_select_hover ik_select_active");m.hover=u;m.active=u;m.hoverIndex=m.listItems.index(u);s.css("left","");if(m.options.ddFullWidth&&t.offset().left+s.outerWidth(true)>b.width()){s.css("left",(s.offset().left+s.outerWidth(true)-b.width())*(-1))}s.css("top","");if(m.options.topShift&&s.offset().top+s.outerHeight(true)>b.scrollTop()+b.height()){s.css("top",((s.offset().top+s.outerHeight(true)-parseInt(s.css("top"),10))-(b.scrollTop()+b.height()))*(-1))}var p=s.offset().left;if(p<0){p=0}var y=s.offset().top;s.css("width","");s.width(s.width());s.appendTo("body").css({left:p,top:y});var n=f(".ik_select_active",w).position().top-w.height()/2;w.data("ik_select_scrollTop",n);x.scrollTop(n);a=z;m.options.onShow(m);z.trigger("ikshow",[m])},add_options:function(q){var n=this;var m=n.select;var r=n.listInner;var p="",o="";f.each(q,function(t,v){if(typeof v==="string"){p+='<li><span class="ik_select_option" title="'+t+'">'+v+"</span></li>";o+='<option value="'+t+'">'+v+"</option>"}else{if(typeof v==="object"){var u=f("> ul > li.ik_select_optgroup:eq("+t+") > ul",r);var s=f("optgroup:eq("+t+")",m);var w=v;f.each(w,function(x,y){p+='<li><span class="ik_select_option" title="'+x+'">'+y+"</span></li>";o+='<option value="'+x+'">'+y+"</option>"});u.append(p);s.append(o);p="";o=""}}});if(o!==""){f(":first",r).append(p);m.append(o)}n._fix_height();n.listItems=f("li:not(.ik_select_optgroup)",r);n._attach_list_events(n.listItems)},remove_options:function(o){var n=this;var m=n.select;var p=n.listItems;var q=f([]);f.each(o,function(r,s){f("option",m).each(function(t){if(f(this).val()===s){q=q.add(f(this)).add(p.eq(t))}})});n.listItems=p.not(q);q.remove();n._select_fake_option();n._fix_height()},_select_real_option:function(){var m=this.hover;var n=this.active;n.removeClass("ik_select_active");m.addClass("ik_select_active").click()},_select_fake_option:function(){var n=this;var m=n.select;var q=n.link;var o=n.linkText;var s=n.listItems;var p=f(":selected",m);var r=f("option",m).index(p);o.html(p.html());if(p.length&&p[0].getAttribute("value")){q.removeClass("ik_select_link_novalue")}else{q.addClass("ik_select_link_novalue")}n.hover=s.removeClass("ik_select_hover ik_select_active").eq(r).addClass("ik_select_hover ik_select_active");n.active=n.hover},disable_select:function(){var m=this.select;var n=this.link;m.attr("disabled","disabled");n.addClass("ik_select_link_disabled")},enable_select:function(){var m=this.select;var n=this.link;m.removeAttr("disabled");n.removeClass("ik_select_link_disabled")},toggle_select:function(){var m=this;var n=this.link;if(n.hasClass("ik_select_link_disabled")){m.enable_select()}else{m.disable_select()}},make_selection:function(o){var n=this;var m=n.select;m.val(o);n._select_fake_option()},disable_optgroups:function(o){var n=this;var m=n.select;var p=n.list;f.each(o,function(r,s){var q=f("optgroup:eq("+s+")",m);q.attr("disabled","disabled");f(".ik_select_optgroup:eq("+s+")",p).addClass("ik_select_optgroup_disabled");n.disable_options(f("option",q))});n._select_fake_option()},enable_optgroups:function(o){var n=this;var m=n.select;var p=n.list;f.each(o,function(r,s){var q=f("optgroup:eq("+s+")",m);q.removeAttr("disabled");f(".ik_select_optgroup:eq("+s+")",p).removeClass("ik_select_optgroup_disabled");n.enable_options(f("option",q))});n._select_fake_option()},disable_options:function(o){var n=this;var m=n.select;var p=n.listItems;var q=f("option",m);f.each(o,function(s,t){if(typeof t==="object"){f(this).attr("disabled","disabled");var u=q.index(this);var r=p.eq(u).addClass("ik_select_option_disabled");n._detach_list_events(r)}else{q.each(function(w){if(f(this).val()===t){f(this).attr("disabled","disabled");var v=p.eq(w).addClass("ik_select_option_disabled");n._detach_list_events(v);return this}})}});n._select_fake_option()},enable_options:function(o){var n=this;var m=n.select;var p=n.listItems;var q=f("option",m);f.each(o,function(s,t){if(typeof t==="object"){f(this).removeAttr("disabled");var u=q.index(this);var r=p.eq(u).removeClass("ik_select_option_disabled");n._attach_list_events(r)}else{q.each(function(w){if(f(this).val()===t){f(this).removeAttr("disabled");var v=p.eq(w).removeClass("ik_select_option_disabled");n._attach_list_events(v);return this}})}});n._select_fake_option()},detach_plugin:function(){var n=this;var m=n.select;var o=n.fakeSelect;m.unbind(".ikSelect").css({width:"",height:"",left:"",top:"",position:"",margin:"",padding:""});o.before(m);o.remove()},_move_to:function(t){var m=this;var u=m.select;var n=m.linkText;var o=m.block;var r=m.list;var s=m.listInner;if(!o.is(":visible")&&f.browser.webkit){m.show_block();return this}m.hover.removeClass("ik_select_hover");t.addClass("ik_select_hover");m.hover=t;if(!f.browser.webkit){m.active.removeClass("ik_select_active");t.addClass("ik_select_active");m.active=t}if(!o.is(":visible")||f.browser.mozilla){if(!f.browser.mozilla){u.val(f(".ik_select_option",t).attr("title"));u.change()}n.html(f(".ik_select_option",t).html())}var p=t.offset().top-r.offset().top-parseInt(r.css("paddingTop"),10);var q=p+t.outerHeight();if(q>r.height()){s.scrollTop(s.scrollTop()+q-r.height())}else{if(p<0){s.scrollTop(s.scrollTop()+p)}}m.options.onHoverMove(t,m);u.trigger("ikhovermove",[t,m])},_fix_height:function(){var m=this;var q=m.block;var p=m.listInner;var n=m.options.ddMaxHeight;var o=m.options.ddFullWidth;q.show();p.css("height","auto");if(p.height()>n){p.css({overflow:"auto",height:n,position:"relative"});if(!f.data(p,"ik_select_hasScrollbar")){if(o){q.width(q.width()+g);p.width(p.width()+g)}}f.data(p,"ik_select_hasScrollbar",true)}else{if(f.data(p,"ik_select_hasScrollbar")){p.css({overflow:"",height:"auto"});p.width(p.width()-g);q.width(q.width()-g)}}q.hide()}});f.fn.ikSelect=function(n){if(e){return this}var m=Array.prototype.slice.call(arguments);return this.each(function(){if(!f.data(this,"plugin_ikSelect")){f.data(this,"plugin_ikSelect",new k(this,n))}else{if(typeof n==="string"){var o=f.data(this,"plugin_ikSelect");switch(n){case"reset":o.reset_all();break;case"hide_dropdown":o.hide_block();break;case"show_dropdown":i=true;o.select.focus();o.show_block();break;case"add_options":o.add_options(m[1]);break;case"remove_options":o.remove_options(m[1]);break;case"enable":o.enable_select();break;case"disable":o.disable_select();break;case"toggle":o.toggle_select();break;case"select":o.make_selection(m[1]);break;case"set_defaults":o.set_defaults(m[1]);break;case"redraw":o.redraw();break;case"disable_options":o.disable_options(m[1]);break;case"enable_options":o.enable_options(m[1]);break;case"disable_optgroups":o.disable_optgroups(m[1]);break;case"enable_optgroups":o.enable_optgroups(m[1]);break;case"detach":o.detach_plugin();break}}}})};f.ikSelect=new k();f(j).bind("click.ikSelect",function(m){if(!i&&a.length&&!f(m.target).closest(".ik_select").length&&!f(m.target).closest(".ik_select_block").length){a.ikSelect("hide_dropdown");a=f([])}if(i){i=false}})})(jQuery,window,document);